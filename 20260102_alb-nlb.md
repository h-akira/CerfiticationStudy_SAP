# ALB と NLB

作成日: 2026-01-02

## 概要

Application Load Balancer（ALB）とNetwork Load Balancer（NLB）はElastic Load Balancing（ELB）の2つの主要なタイプです。ALBはHTTP/HTTPSのレイヤー7、NLBはTCP/UDPのレイヤー4で動作し、用途とパフォーマンス特性が異なります。

## 基本比較

| 項目 | ALB | NLB |
|---|---|---|
| **OSI層** | レイヤー7（アプリケーション層） | レイヤー4（トランスポート層） |
| **プロトコル** | HTTP、HTTPS、HTTP/2、gRPC | TCP、UDP、TLS |
| **ターゲット** | IPアドレス、インスタンス、Lambda | IPアドレス、インスタンス、ALB |
| **パフォーマンス** | 中程度 | 超高速（100万req/秒以上） |
| **レイテンシ** | ミリ秒単位 | マイクロ秒単位 |
| **IPアドレス** | 動的（DNSのみ） | 静的IP対応（Elastic IP割り当て可） |
| **料金** | $0.0225/時間 + LCU | $0.0225/時間 + NLCU |

## プロトコルとポート

### ALB

| プロトコル | 用途 | 特徴 |
|---|---|---|
| **HTTP** | Webアプリケーション | パス、ホストベースルーティング |
| **HTTPS** | セキュアなWebアプリ | SSL/TLS終端、証明書管理 |
| **HTTP/2** | モダンなWebアプリ | マルチプレックス、ヘッダー圧縮 |
| **gRPC** | マイクロサービス | HTTP/2ベースのRPC |
| **WebSocket** | リアルタイム通信 | 双方向通信 |

**リスナーポート**: 1〜65535（複数リスナー可）

### NLB

| プロトコル | 用途 | 特徴 |
|---|---|---|
| **TCP** | 汎用TCP通信 | コネクション維持、高スループット |
| **UDP** | DNS、ゲーム、ストリーミング | コネクションレス |
| **TLS** | 暗号化TCP | SSL/TLS終端 |
| **TCP_UDP** | 同一ポートでTCP/UDP | 柔軟なプロトコル対応 |

**リスナーポート**: 1〜65535（複数リスナー可）

## ルーティング機能

### ALB

| ルーティング種類 | 説明 | 例 |
|---|---|---|
| **パスベース** | URLパスで振り分け | `/api/*` → API サーバー、`/images/*` → 画像サーバー |
| **ホストベース** | ホストヘッダーで振り分け | `api.example.com` → API、`www.example.com` → Web |
| **HTTPヘッダー** | カスタムヘッダーで振り分け | `X-User-Type: premium` → プレミアムサーバー |
| **HTTPメソッド** | GET、POSTなどで振り分け | `POST` → 書き込みサーバー、`GET` → 読み取りサーバー |
| **クエリ文字列** | URLパラメータで振り分け | `?version=v2` → v2サーバー |
| **送信元IP** | クライアントIPで振り分け | `192.168.0.0/16` → 内部サーバー |

**優先順位**: 条件に複数一致する場合、最も具体的なルールが適用

### NLB

| ルーティング種類 | 説明 |
|---|---|
| **ポートベース** | リスナーポートでターゲットグループを選択 |
| **固定ルーティング** | レイヤー4のため、コンテンツベースルーティング不可 |

**制限**: HTTPヘッダー、パス、ホスト名などのレイヤー7情報は参照不可

## ターゲットとヘルスチェック

### ALB

| ターゲットタイプ | 説明 | 用途 |
|---|---|---|
| **instance** | EC2インスタンスID | 従来型のEC2ベースアプリ |
| **ip** | IPアドレス（プライベート） | コンテナ、オンプレミス（VPN/DX経由） |
| **lambda** | Lambda関数 | サーバーレスアプリケーション |

**ヘルスチェック**:
- プロトコル: HTTP、HTTPS
- パス指定可能（例: `/health`）
- ステータスコード指定（例: 200、200-299）
- 間隔: 5〜300秒

### NLB

| ターゲットタイプ | 説明 | 用途 |
|---|---|---|
| **instance** | EC2インスタンスID | EC2ベースアプリ |
| **ip** | IPアドレス（プライベート） | コンテナ、オンプレミス |
| **alb** | ALB | NLBの静的IP + ALBのレイヤー7機能 |

**ヘルスチェック**:
- プロトコル: TCP、HTTP、HTTPS
- TCP: 接続成功で正常
- HTTP/HTTPS: ステータスコード確認可能
- 間隔: 10〜300秒

## パフォーマンスとスケーリング

### ALB

| 項目 | 内容 |
|---|---|
| **スループット** | 中程度（数万req/秒） |
| **レイテンシ** | 数ミリ秒 |
| **スケーリング** | 自動（トラフィック増加に数分） |
| **ウォームアップ** | 急激なトラフィック増加時は事前通知推奨 |
| **コネクション** | リクエストごとに新しいコネクション |

### NLB

| 項目 | 内容 |
|---|---|
| **スループット** | 超高速（100万req/秒以上） |
| **レイテンシ** | 100マイクロ秒以下 |
| **スケーリング** | 即座（瞬時のトラフィック急増に対応） |
| **ウォームアップ** | 不要 |
| **コネクション** | クライアント-ターゲット間で維持 |

## 送信元IPの保持

### ALB

| 項目 | 内容 |
|---|---|
| **デフォルト動作** | ALBのプライベートIPが送信元になる |
| **X-Forwarded-For** | 元のクライアントIPをヘッダーに追加 |
| **X-Forwarded-Port** | 元のポート番号 |
| **X-Forwarded-Proto** | 元のプロトコル（HTTP/HTTPS） |
| **ターゲット側** | HTTPヘッダーから取得 |

### NLB

| 項目 | 内容 |
|---|---|
| **デフォルト動作** | クライアントIPをそのまま保持 |
| **設定不要** | レイヤー4のため透過的 |
| **ターゲット側** | 接続元IPとして直接取得 |
| **Proxy Protocol v2** | ターゲットがコンテナの場合など、追加情報取得可能 |

## セキュリティ機能

### ALB

| 機能 | 説明 |
|---|---|
| **SSL/TLS終端** | ALBで証明書を管理、バックエンドは平文可 |
| **ACM統合** | AWS Certificate Manager証明書使用 |
| **SNI** | 複数ドメイン・証明書対応 |
| **セキュリティグループ** | ALBにセキュリティグループ適用 |
| **WAF統合** | AWS WAFでアプリケーション保護 |
| **固定レスポンス** | 特定条件でALBが直接応答（リダイレクト等） |
| **認証** | Cognito、OIDC統合（ログイン機能） |

### NLB

| 機能 | 説明 |
|---|---|
| **TLS終端** | NLBで証明書を管理 |
| **ACM統合** | AWS Certificate Manager証明書使用 |
| **SNI** | 複数証明書対応 |
| **セキュリティグループ** | **非対応**（ターゲット側で設定） |
| **送信元IP保持** | クライアントIPをそのまま転送 |
| **Proxy Protocol** | メタデータ追加転送 |

**重要**: NLBはセキュリティグループ非対応。ターゲットのセキュリティグループでクライアントIPを許可。

## 可用性とスケーリング

### ALB

| 項目 | 内容 |
|---|---|
| **マルチAZ** | 必須（最低2つのAZ） |
| **AZ障害** | 自動フェイルオーバー |
| **クロスゾーン負荷分散** | デフォルト有効（無料） |
| **スケーリング** | 自動（数分かかる場合あり） |

### NLB

| 項目 | 内容 |
|---|---|
| **マルチAZ** | 必須（最低2つのAZ） |
| **AZ障害** | 自動フェイルオーバー |
| **クロスゾーン負荷分散** | デフォルト無効（有効化可能、AZ間データ転送料金） |
| **スケーリング** | 即座 |

## 静的IPとDNS

### ALB

| 項目 | 内容 |
|---|---|
| **IPアドレス** | 動的（変動する） |
| **アクセス方法** | DNSのみ |
| **DNS名** | 自動割り当て（例: `my-alb-123456789.us-east-1.elb.amazonaws.com`） |
| **Route 53統合** | Aレコード（エイリアス）で設定 |

### NLB

| 項目 | 内容 |
|---|---|
| **IPアドレス** | 静的（Elastic IP割り当て可能） |
| **AZごと** | 各AZに1つのIPアドレス |
| **アクセス方法** | DNS or 直接IP |
| **ファイアウォール許可** | IPホワイトリスト可能 |
| **Route 53統合** | Aレコード（エイリアス）またはIPアドレス |

**ユースケース**: オンプレミスから固定IPでアクセスが必要な場合はNLB

## 料金

### ALB

| 料金要素 | 内容 |
|---|---|
| **時間料金** | $0.0225/時間 |
| **LCU** | Load Balancer Capacity Unit（使用量ベース） |
| **LCU計算** | 新規接続数、アクティブ接続数、処理バイト数、ルール評価のうち最大 |
| **LCU料金** | $0.008/LCU/時間 |

**例**: 1,000接続/秒、100 Mbpsの場合、約$20〜30/月

### NLB

| 料金要素 | 内容 |
|---|---|
| **時間料金** | $0.0225/時間 |
| **NLCU** | Network Load Balancer Capacity Unit |
| **NLCU計算** | 新規接続数、アクティブ接続数、処理バイト数のうち最大 |
| **NLCU料金** | $0.006/NLCU/時間 |

**例**: 1,000接続/秒、100 Mbpsの場合、約$15〜25/月

**注意**: クロスゾーン負荷分散有効時はAZ間データ転送料金が追加

## 特殊な構成

### NLB → ALB

```
[Client] → [NLB (静的IP)] → [ALB (レイヤー7)] → [EC2/ECS]
```

| メリット | 説明 |
|---|---|
| **静的IP** | NLBの固定IPでアクセス |
| **レイヤー7機能** | ALBのパス・ホストベースルーティング |
| **ファイアウォール** | IPホワイトリスト可能 |

**用途**: オンプレミスファイアウォールでIP制限が必要 + アプリケーションルーティングが必要

### Global Accelerator + NLB/ALB

| 項目 | 内容 |
|---|---|
| **静的IP（2つ）** | Global Acceleratorが提供 |
| **グローバル分散** | 複数リージョンのロードバランサーへルーティング |
| **パフォーマンス** | AWSグローバルネットワーク経由 |

## ユースケース別推奨

| ユースケース | 推奨 | 理由 |
|---|---|---|
| **Webアプリケーション** | ALB | HTTP/HTTPS、パスルーティング、WAF統合 |
| **マイクロサービス（HTTP）** | ALB | パスベースルーティング、コンテナ統合 |
| **REST API** | ALB | ホスト・パスルーティング、認証統合 |
| **gRPC** | ALB | HTTP/2、gRPCネイティブサポート |
| **超高速TCP** | NLB | マイクロ秒レイテンシ、100万req/秒 |
| **UDP（DNS、ゲーム）** | NLB | UDP対応 |
| **静的IP必要** | NLB | Elastic IP割り当て可能 |
| **送信元IP保持** | NLB | クライアントIPそのまま転送 |
| **オンプレ統合（固定IP）** | NLB → ALB | 静的IP + レイヤー7機能 |
| **PrivateLink** | NLB | VPCエンドポイントサービス |
| **Lambda（HTTP）** | ALB | Lambdaターゲット対応 |
| **極端なトラフィック変動** | NLB | 即座のスケーリング |

## 制限と注意点

### ALB

| 制限 | 内容 |
|---|---|
| **ターゲット数** | 1,000/ターゲットグループ |
| **ターゲットグループ数** | 100/リージョン（上限緩和可） |
| **ルール数** | 100/リスナー |
| **証明書数** | 25/ロードバランサー（SNI） |
| **Lambda** | レスポンスサイズ1MB制限 |

### NLB

| 制限 | 内容 |
|---|---|
| **ターゲット数** | 1,000/ターゲットグループ |
| **ターゲットグループ数** | 100/リージョン（上限緩和可） |
| **Elastic IP** | 1/AZ |
| **セキュリティグループ** | 非対応（ターゲット側で設定） |

## SAP試験の重要ポイント

### ALB

- **レイヤー7**: HTTP/HTTPS、パス・ホストベースルーティング
- **ターゲット**: インスタンス、IP、Lambda
- **WAF統合**: Webアプリケーション保護
- **認証**: Cognito、OIDC統合
- **送信元IP**: X-Forwarded-Forヘッダー
- **IPアドレス**: 動的（DNSのみ）

### NLB

- **レイヤー4**: TCP、UDP、TLS
- **パフォーマンス**: 超高速（100万req/秒、マイクロ秒レイテンシ）
- **静的IP**: Elastic IP割り当て可能
- **送信元IP**: そのまま保持（透過的）
- **セキュリティグループ**: 非対応
- **ターゲット**: インスタンス、IP、ALB

### 使い分け

- **Webアプリ**: ALB
- **超高速・静的IP・UDP**: NLB
- **静的IP + レイヤー7**: NLB → ALB
- **PrivateLink**: NLB（必須）
- **クロスゾーン負荷分散**: ALB（無料）、NLB（有料、デフォルト無効）
